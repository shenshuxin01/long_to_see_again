  .   ____          _            __ _ _
 /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \
( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \
 \\/  ___)| |_)| | | | | || (_| |  ) ) ) )
  '  |____| .__|_| |_|_| |_\__, | / / / /
 =========|_|==============|___/=/_/_/_/

 :: Spring Boot ::                (v3.3.0)

# 创建context
public AnnotationConfigServletWebServerApplicationContext() {
    this.reader = new AnnotatedBeanDefinitionReader(this);
    this.scanner = new ClassPathBeanDefinitionScanner(this);
}

# 创建beanFactory 也是在实例化context时候创建的
public GenericApplicationContext() {
    this.beanFactory = new DefaultListableBeanFactory();
}
public class AnnotationConfigServletWebServerApplicationContext extends ServletWebServerApplicationContext
public class ServletWebServerApplicationContext extends GenericWebApplicationContext
public class GenericWebApplicationContext extends GenericApplicationContext
public class GenericApplicationContext extends AbstractApplicationContext
GenericApplicationContext是AnnotationConfigServletWebServerApplicationContext父类

# 注册内部beanDefinition
public AnnotatedBeanDefinitionReader(BeanDefinitionRegistry registry, Environment environment) {
    this.registry = registry;
    this.conditionEvaluator = new ConditionEvaluator(registry, environment, null);
    AnnotationConfigUtils.registerAnnotationConfigProcessors(this.registry);
}
beanDefinitionNames：
0 = "org.springframework.context.annotation.internalConfigurationAnnotationProcessor"
1 = "org.springframework.context.annotation.internalAutowiredAnnotationProcessor"
2 = "org.springframework.context.annotation.internalCommonAnnotationProcessor"
3 = "org.springframework.context.event.internalEventListenerProcessor"
4 = "org.springframework.context.event.internalEventListenerFactory"


# 注册beanFactoryPostProcessor
new SpringApplication()对象的构造方法中：
setInitializers((Collection) getSpringFactoriesInstances(ApplicationContextInitializer.class));
SpringFactoriesLoader.forDefaultResourceLocation(getClassLoader()).load(type, argumentResolver);
forResourceLocation("META-INF/spring.factories", classLoader);
添加了下面的实例化对象
getInitializers() = {LinkedHashSet@4278}  size = 7
 0 = {DelegatingApplicationContextInitializer@4235} 
 1 = {SharedMetadataReaderFactoryContextInitializer@4186} 
 2 = {ContextIdApplicationContextInitializer@4236} 
 3 = {ConfigurationWarningsApplicationContextInitializer@4237} 
 4 = {RSocketPortInfoApplicationContextInitializer@4238} 
 5 = {ServerPortInfoApplicationContextInitializer@4239} 
 6 = {ConditionEvaluationReportLoggingListener@4240} 

然后的run方法的prepareContext方法中：（applyInitializers）
for (ApplicationContextInitializer initializer : getInitializers()) {
    initializer.initialize(context);
}
## SharedMetadataReaderFactoryContextInitializer 实现：
@Override
public void initialize(ConfigurableApplicationContext applicationContext) {
    if (AotDetector.useGeneratedArtifacts()) {
        return;
    }
    BeanFactoryPostProcessor postProcessor = new CachingMetadataReaderFactoryPostProcessor(applicationContext);
    applicationContext.addBeanFactoryPostProcessor(postProcessor); //这一步就是注册
}
## ConfigurationWarningsApplicationContextInitializer 实现：
@Override
public void initialize(ConfigurableApplicationContext context) {
    context.addBeanFactoryPostProcessor(new ConfigurationWarningsPostProcessor(getChecks()));
}
## 然后的run方法的prepareContext方法中：
context.addBeanFactoryPostProcessor(new PropertySourceOrderingBeanFactoryPostProcessor(context));

共计添加了三个


# 注册singletonObjects
1. run.prepareContext方法
run方法的prepareContext方法中：（applyInitializers）
for (ApplicationContextInitializer initializer : getInitializers()) {
    initializer.initialize(context);
}
## ContextIdApplicationContextInitializer 实现
@Override
public void initialize(ConfigurableApplicationContext applicationContext) {
    ContextId contextId = getContextId(applicationContext);
    applicationContext.setId(contextId.getId());
    applicationContext.getBeanFactory().registerSingleton(ContextId.class.getName(), contextId);//注册实例
}

## ConditionEvaluationReportLoggingListener 实现
@Override
public void initialize(ConfigurableApplicationContext applicationContext) {
    applicationContext.addApplicationListener(new ConditionEvaluationReportListener(applicationContext));
}
beanFactory.registerSingleton("autoConfigurationReport", report);

## prepareContext方法中
beanFactory.registerSingleton("springApplicationArguments", applicationArguments);
beanFactory.registerSingleton("springBootBanner", printedBanner);

### 监听加载上下文
listeners.contextLoaded(context);
EventPublishingRunListener.contextLoaded()方法
if (!beanFactory.containsBean(LOGGING_SYSTEM_BEAN_NAME)) {
    beanFactory.registerSingleton(LOGGING_SYSTEM_BEAN_NAME, this.loggingSystem);
}
if (this.logFile != null && !beanFactory.containsBean(LOG_FILE_BEAN_NAME)) {
    beanFactory.registerSingleton(LOG_FILE_BEAN_NAME, this.logFile);
}
if (this.loggerGroups != null && !beanFactory.containsBean(LOGGER_GROUPS_BEAN_NAME)) {
    beanFactory.registerSingleton(LOGGER_GROUPS_BEAN_NAME, this.loggerGroups);
}
if (!beanFactory.containsBean(LOGGING_LIFECYCLE_BEAN_NAME) && applicationContext.getParent() == null) {
    beanFactory.registerSingleton(LOGGING_LIFECYCLE_BEAN_NAME, new Lifecycle());
}

registeredSingletons = {LinkedHashSet@4504}  size = 7
 0 = "org.springframework.boot.context.ContextIdApplicationContextInitializer$ContextId"
 1 = "autoConfigurationReport"
 2 = "springApplicationArguments"
 3 = "springBootBanner"
 4 = "springBootLoggingSystem"
 5 = "springBootLoggerGroups"
 6 = "springBootLoggingLifecycle"

 2. run.refreshContext方法
prepareBeanFactory(beanFactory);
if (!beanFactory.containsLocalBean(ENVIRONMENT_BEAN_NAME)) {
    beanFactory.registerSingleton(ENVIRONMENT_BEAN_NAME, getEnvironment());
}
if (!beanFactory.containsLocalBean(SYSTEM_PROPERTIES_BEAN_NAME)) {
    beanFactory.registerSingleton(SYSTEM_PROPERTIES_BEAN_NAME, getEnvironment().getSystemProperties());
}
if (!beanFactory.containsLocalBean(SYSTEM_ENVIRONMENT_BEAN_NAME)) {
    beanFactory.registerSingleton(SYSTEM_ENVIRONMENT_BEAN_NAME, getEnvironment().getSystemEnvironment());
}
if (!beanFactory.containsLocalBean(APPLICATION_STARTUP_BEAN_NAME)) {
    beanFactory.registerSingleton(APPLICATION_STARTUP_BEAN_NAME, getApplicationStartup());
}

registeredSingletons = {LinkedHashSet@4504}  size = 11
 0 = "org.springframework.boot.context.ContextIdApplicationContextInitializer$ContextId"
 1 = "autoConfigurationReport"
 2 = "springApplicationArguments"
 3 = "springBootBanner"
 4 = "springBootLoggingSystem"
 5 = "springBootLoggerGroups"
 6 = "springBootLoggingLifecycle"
 7 = "environment"
 8 = "systemProperties"
 9 = "systemEnvironment"
 10 = "applicationStartup"


# run.refresh.invokeBeanFactoryPostProcessors()方法
## 此方法执行前，记录一下beanFactory属性
### beanDefinitionNames = {ArrayList@4657}  size = 6
 0 = "org.springframework.context.annotation.internalConfigurationAnnotationProcessor"
 1 = "org.springframework.context.annotation.internalAutowiredAnnotationProcessor"
 2 = "org.springframework.context.annotation.internalCommonAnnotationProcessor"
 3 = "org.springframework.context.event.internalEventListenerProcessor"
 4 = "org.springframework.context.event.internalEventListenerFactory"
 5 = "updownloadfileApplication"

 ### registeredSingletons = {LinkedHashSet@4680}  size = 11
 0 = "org.springframework.boot.context.ContextIdApplicationContextInitializer$ContextId"
 1 = "autoConfigurationReport"
 2 = "springApplicationArguments"
 3 = "springBootBanner"
 4 = "springBootLoggingSystem"
 5 = "springBootLoggerGroups"
 6 = "springBootLoggingLifecycle"
 7 = "environment"
 8 = "systemProperties"
 9 = "systemEnvironment"
 10 = "applicationStartup"


首先加载
BeanDefinitionRegistryPostProcessor
然后加载
BeanFactoryPostProcessor

最重要的是beanDefinition
 0 = "org.springframework.context.annotation.internalConfigurationAnnotationProcessor"
会加载项目用到的bean（自己开发的bean）
ConfigurationClassPostProcessor.postProcessBeanDefinitionRegistry()方法